# ä½¿ç”¨æ¨¡æ¿ç¼–è¾‘é¡µé¢

[TOC]

ä¸Šå‡ èŠ‚ï¼Œæˆ‘ä»¬è®²è§£äº†æ•°æ®åº“çš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼šè¿æ¥ã€æŸ¥è¯¢ã€ç¼“å­˜ã€‚åé¢æˆ‘ç»§ç»­è®²è§£æ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹ã€‚
åœ¨è®²è§£è¿™äº›ä¹‹å‰ï¼Œæˆ‘éœ€è¦è®²è§£ä¸€ä¸‹ï¼Œ`Axum`çš„æ¨¡æ¿æ“ä½œï¼Œä¸ºä»€ä¹ˆè¦è®²è§£æ¨¡æ¿æ“ä½œå“ªï¼Ÿå› ä¸ºæ•°æ®åº“çš„å¢ã€åˆ ã€æ”¹éƒ½ä¼šæ¶‰åŠé¡µé¢çš„å‰ç«¯æ“ä½œï¼Œå½“ç„¶ï¼ŒæŒ‰ç…§ç°åœ¨æµè¡Œçš„è¶‹åŠ¿ï¼Œåº”è¯¥æ˜¯é‡‡ç”¨å‰ååˆ†ç¦»çš„æ–¹å¼æ“ä½œã€‚`Axum`åªè¦åšå¥½`API`æ¥å£å°±å¥½ï¼Œå‰ç«¯ç”±`vue`ã€ `angular`ã€`react`æ¥å®ç°ã€‚
ä¸è¿‡åŸºäºä¸¤ä¸ªåŸå› æˆ‘è¦è®²è§£ä¸€ä¸‹æ¨¡æ¿ï¼š
- æ¨¡æ¿æ˜¯`Axum`çš„ä¸€ä¸ªé‡è¦çš„æŠ€æœ¯ç‚¹
- æœ¬äººä¸ä¼šè¿™ä¸‰å¤§æ¡†æ¶ğŸ˜„

## æ¨¡æ¿è®¾ç½®

```shell
$ mkdir templates
```

ä¸`src`å¹³è¡Œçš„ä½ç½®å»ºç«‹ä¸€ä¸ªç›®å½•â€”â€”`templates`ï¼Œç”¨äºå­˜å‚¨æ¨¡æ¿æ–‡ä»¶ã€‚ä¸ºäº†ä½¿æ•´ä¸ªå·¥ç¨‹çœ‹èµ·æ¥ä¸“ä¸šã€æ•´é½ï¼Œæˆ‘ä»¬åšä¸€ä¸ªçº¦å®šï¼Œé‚£å°±æ˜¯åœ¨`controller`ç›®å½•é‡Œé¢çš„æ–‡ä»¶å«ä»€ä¹ˆåå­—ï¼Œåœ¨`templates`é‡Œé¢å°±å»ºä¸€ä¸ªç›¸åŒçš„ç›®å½•ä½œä¸ºæ•´ä¸ªæ–‡ä»¶çš„æ¨¡æ¿ç›®å½•ã€‚æ¯”å¦‚`controller/tag.rs`å°±å»ºç«‹ä¸€ä¸ª`templates/tag`çš„ç›®å½•ã€‚

```shell
$ mkdir -p templates/tag
$ cargo add askama
```
`askama`è¿™ä¸ª`crate` æ˜¯æ“ä½œæ¨¡æ¿çš„ã€‚

```toml
[dependencies]
askama = "0.11"
```



ä¿®æ”¹`controller/mod.rs`ï¼š

```rust
use crate::{config::WebInfo,AppError,Result};
pub mod index;
pub mod tag;
use axum::{
   response::Html,
};
use askama::Template;
#[allow(dead_code)]
fn get_web_info<'a>(state: &'a WebInfo) -> WebInfo{
   state.to_owned()
}
/// æ¸²æŸ“æ¨¡æ¿
fn render<T: Template>(tpl: T, handler_name: &str) -> Result<super::util::types::HtmlResponse> {
   let out = tpl
       .render()
       .map_err(AppError::from)
       .map_err(log_error(handler_name))?;
   Ok(Html(out))
}
/// è®°å½•é”™è¯¯
fn log_error(handler_name: &str) -> Box<dyn Fn(AppError) -> AppError> {
   let handler_name = handler_name.to_string();
   Box::new(move |err| {
       tracing::error!("{}: {:?}", handler_name, err);
       err
   })
}
```



## å¤‡ä»½æ•°æ®åº“

å¯¹äº`tag`è¿™ä¸ªè¡¨æ¥è¯´ï¼Œå¢ã€åˆ ã€æ”¹é‡Œé¢æœ€ç®€å•çš„æ“ä½œä½¿åˆ é™¤ï¼Œå› ä¸ºç›¸å¯¹é¡µé¢æ“ä½œä¼šç®€å•ä¸€äº›ï¼Œå…¶å®ƒçš„æ“ä½œéƒ½éœ€è¦æŠŠ`tag`çš„`BTee`ç»“æ„æ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œè¿™ä¸ª`BTee`ç»“æ„æ˜¾ç¤ºæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæˆ‘ä¼šåœ¨åé¢è¯¦ç»†è®²è§£ã€‚

ä¸è¿‡ï¼Œæ•°æ®åº“çš„åˆ é™¤æ˜¯ä¸€ä¸ªå±é™©çš„åŠ¨ä½œï¼Œä¼šç ´åæ‰æ‰€æœ‰æ•°æ®ï¼Œä¸ºäº†æ•°æ®ä¸ä¸¢å¤±ï¼Œæˆ‘ä»¬é¦–å…ˆæŠŠæ•°æ®åº“é‡Œé¢çš„å†…å®¹å¤‡ä»½ä¸€ä¸‹ï¼š

```shell
$ pg_dump -h 127.0.0.1 -U sa helloworld > helloworld.pgdb
$ cat helloworld.pgdb
--
-- PostgreSQL database dump
--

-- Dumped from database version 13.10 (Debian 13.10-1.pgdg110+1)
-- Dumped by pg_dump version 14.6 (Ubuntu 14.6-0ubuntu0.22.04.1)

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: sunny_rbac; Type: SCHEMA; Schema: -; Owner: sa
--

CREATE SCHEMA sunny_rbac;


ALTER SCHEMA sunny_rbac OWNER TO sa;

SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: tag; Type: TABLE; Schema: sunny_rbac; Owner: sa
--

CREATE TABLE sunny_rbac.tag (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    pid integer NOT NULL
);


ALTER TABLE sunny_rbac.tag OWNER TO sa;

--
-- Name: tag_id_seq; Type: SEQUENCE; Schema: sunny_rbac; Owner: sa
--

CREATE SEQUENCE sunny_rbac.tag_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE sunny_rbac.tag_id_seq OWNER TO sa;

--
-- Name: tag_id_seq; Type: SEQUENCE OWNED BY; Schema: sunny_rbac; Owner: sa
--

ALTER SEQUENCE sunny_rbac.tag_id_seq OWNED BY sunny_rbac.tag.id;


--
-- Name: tag id; Type: DEFAULT; Schema: sunny_rbac; Owner: sa
--

ALTER TABLE ONLY sunny_rbac.tag ALTER COLUMN id SET DEFAULT nextval('sunny_rbac.tag_id_seq'::regclass);


--
-- Data for Name: tag; Type: TABLE DATA; Schema: sunny_rbac; Owner: sa
--

COPY sunny_rbac.tag (id, name, pid) FROM stdin;
0       root    0
1       æ–‡å­—    0
2       QA      1
3       FAQ     1
4       éŸ³é¢‘    0
5       æ­Œæ›²    4
6       æˆæ›²    4
7       éŸ³ä¹    4
8       æ°‘ä¹    7
9       è½»éŸ³ä¹  7
10      äº¤å“ä¹  7
11      ç”µå­éŸ³ä¹        7
12      åŠ¨ä½œ    0
13      æ‰‹ğŸ‘‹    12
14      è„šğŸ©¹     12
\.


--
-- Name: tag_id_seq; Type: SEQUENCE SET; Schema: sunny_rbac; Owner: sa
--

SELECT pg_catalog.setval('sunny_rbac.tag_id_seq', 14, true);


--
-- Name: tag tag_pkey; Type: CONSTRAINT; Schema: sunny_rbac; Owner: sa
--

ALTER TABLE ONLY sunny_rbac.tag
    ADD CONSTRAINT tag_pkey PRIMARY KEY (id);


--
-- PostgreSQL database dump complete
--
```

ç­‰éœ€è¦æ¢å¤çš„æ—¶å€™ï¼Œæ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼š

```shell
$ psql -h localhost -U sa -d helloworld < helloworld.pgdb
```

## ç®€å•çš„æ˜¾ç¤º

åœ¨åšå¤æ‚çš„æ˜¾ç¤ºå‰é¢ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä¸ªç®€å•çš„æ˜¾ç¤ºï¼Œå°±æ˜¯åœ¨é¡µé¢ä¸­æ˜¾ç¤ºä¸€ä¸ª**æ•°æ®æ¥è‡ªtag**ã€‚

### å†™ä¸€ä¸ªç®€å•çš„æ¨¡æ¿

æœ€ç»ˆçš„æ ·å¼åº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„å›¾

![å›¾](./7.11.1.png)

è¿™ä¸ªè¦åœ¨åé¢æ¥å®ç°ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä¸ªç®€å•çš„ï¼Œä¸€ä¸ªè¾“å…¥æ¡†ï¼ˆè¾“å…¥`tag`çš„`id`ï¼‰ï¼Œä¸€ä¸ªç¡®è®¤é”®ã€‚

å¦‚æœè¾“å…¥çš„`id`æ˜¯åˆ«çš„`tag`çš„`pid`,è¿”å›ä¸èƒ½åˆ é™¤ï¼Œå¦‚æœä¸æ˜¯è¿”å›åˆ é™¤ç»“æœã€‚

```mermaid
flowchart TD
    A[å¼€å§‹] --> B[è¾“å…¥id]
    B-->C{pid?}
    C -- Yes --> F[è¿”å›ä¸èƒ½åˆ é™¤]
    C -- No --> D[åˆ é™¤æ“ä½œ]
    D-->E{åˆ é™¤æˆåŠŸ?}
    E -- Yes --> G[è¿”å›åˆ é™¤æˆåŠŸ]
    E -- No --> H[è¿”å›åˆ é™¤å¤±è´¥]
```

![è§å›¾](./7.11.2.jpg)



ç°åœ¨æ­£å¼å†™ä¸€ä¸‹è¿™ä¸ªæ¨¡æ¿ï¼Œ`templates/tag/delete.html`

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Delete</title>
  </head>
  <body>
    <div>
        <form name="del_form" method="post">
            <input type="text" name="id" id="del_id" value="" />
            <input type="submit" value="åˆ é™¤" />
        </form>
    </div>
  </body>
</html>
```



### ä¿®æ”¹ä¸€ä¸‹`controller/tag.rs`

```rust
use axum::{
    Extension,Router,routing::{get} ,
    extract::Path,
    http::{header::HeaderName, HeaderMap, HeaderValue, StatusCode},
    Json,
};
use askama::Template;
use super::{render};
use crate::{model::*,util::*,dbstate::*};
use std::sync::Arc;
use tower_http::{trace::TraceLayer};
pub(crate) fn index_router() -> Router {
    Router::new()
    .route("/list", get(list))
    .route("/tree", get(get_tree))
    .route("/find/:id", get(get_one))
    .route("/del", get(del_form))
    .layer(TraceLayer::new_for_http())
}
#[derive(Template)]
#[template(path = "tag/delete.html")]
pub struct TagDeleteTemplate {}
/// æ˜¾ç¤ºdelé¡µé¢
async fn del_form()-> crate::Result<crate::util::types::HtmlResponse> {
    let handler_name = "DeleteTagById";
    let tpl = TagDeleteTemplate{};
    render(tpl, handler_name)
}
```

è¯·æ±‚ä¸€ä¸‹ï¼š

![åˆ é™¤](./7.11.3.jpg)

æ˜¯æˆ‘è¦çš„ç•Œé¢ï¼Œæˆ‘ä»¬ç»§ç»­ã€‚

## æ¥å—`post`å‚æ•°

`Axum`æœ‰`Form`è¿™æ–¹æ³•æ¥ä¼ è¾“æ•°æ®ï¼Œè·Ÿç€æˆ‘ä¸€æ­¥ä¸€æ­¥æ“ä½œï¼Œgoï¼

ä¿®æ”¹`controller/tag.rs`

```rust
use axum::{
    Extension,Router,routing::{get} ,
    extract::{Path,},
    http::{header::HeaderName, HeaderMap, HeaderValue, StatusCode},
    Json,
    Form,
};
use serde::{Deserialize, Serialize};  // è¿™ä¸ªå¾ˆé‡è¦!!!
// ä¸‹é¢æ²¡æœ‰Deserializeä¼šæŠ¥é”™ï¼Œè€Œä¸”æ˜¯è®©ä½ å®Œå…¨ä¸çŸ¥é“æ€ä¹ˆæ”¹çš„æŠ¥é”™ï¼Œè§ä¸‹å›¾
#[derive(Debug, Clone, PartialEq,Deserialize,  sqlx::FromRow)] 
pub struct DelForm{
    pub id: i32,
}
```

![é”™è¯¯](./7.11.4.jpg)

ç»§ç»­ä¿®æ”¹`controller/tag.rs`

```rust
pub(crate) fn index_router() -> Router {
    Router::new()
    .route("/list", get(list))
    .route("/tree", get(get_tree))
    .route("/find/:id", get(get_one))
    .route("/del", get(del_form).post(do_del))
    .layer(TraceLayer::new_for_http())
}
pub async fn do_del(
    Extension(state): Extension<Arc<DbState>>,
    Form(del_form): Form<DelForm>,
)-> HandlerJsonResult{
    let mut headers = HeaderMap::new();
    headers.insert(
        HeaderName::from_static("content-type"),
        HeaderValue::from_static("application/json;charset=utf-8"),
    );
    tracing::info!("Params:âŒ›{:?}",&del_form.id);
    let result = Json(serde_json::json!({"result":"delete"}));
    let code = StatusCode::OK;
    (code, headers, result)
}
```

è¯·æ±‚ä¸€ä¸‹ï¼š

```shell
$ curl -i -X POST -d "id"=2 127.0.0.1:3000/tag/del
HTTP/1.1 200 OK
content-type: application/json;charset=utf-8
content-length: 19
date: Thu, 23 Feb 2023 06:39:46 GMT

{"result":"delete"}
```

![åˆ é™¤](./7.11.5.jpg)

æ•°æ®å®Œæ•´ï¼Œè¯´æ˜æˆ‘ä»¬çš„`Form`å’Œ`POST`æ–¹æ³•éƒ½æˆåŠŸäº†ä¸‹é¢ï¼Œæˆ‘å¼€å§‹çœŸæ­£çš„`model`æ“ä½œã€‚

```rust
#[allow(dead_code)]
pub async fn delete<'a>(state: &'a DbState,id:i32) -> Result<String> {
    let pool = get_conn(&state);
    let mut sql=format!("SELECT count(1) as count from {} where pid ={}",get_table_name(),id);    
    let rows = sqlx::query_as::<_, CountModel>(&sql)
        .fetch_one(pool)
        .await
        .unwrap();
    if rows.count!=0{
        let code = AppError::from_err(format!("id:{}æ˜¯ä¸ªçˆ¶ç±»ï¼Œä¸èƒ½åˆ é™¤",id).into(),crate::AppErrorType::Database);
        return Err(code);
    }   
    Ok("ok".to_string())
}
```

è¿™ä¸ªæ˜¯å®ç°idæ˜¯ä¸€ä¸ªpidï¼Œä¸èƒ½è¢«åˆ é™¤ã€‚

å®Œæ•´çš„ä»£ç ï¼š

```rust
#[allow(dead_code)]
pub async fn delete<'a>(state: &'a DbState,id:i32) -> Result<String> {
    let pool = get_conn(&state);
    let mut sql=format!("SELECT count(1) as count from {} where pid ={}",get_table_name(),id);    
    let rows = sqlx::query_as::<_, CountModel>(&sql)
        .fetch_one(pool)
        .await
        .unwrap();
    if rows.count!=0{
        let code = AppError::from_err(format!("id:{}æ˜¯ä¸ªçˆ¶ç±»ï¼Œä¸èƒ½åˆ é™¤",id).into(),crate::AppErrorType::Database);
        return Err(code);
    }
    sql=format!("Delete from {} where id ={}",get_table_name(),id);
    let res=sqlx::query(&sql)
    .execute(pool)
    .await;
    match res {
        Ok(result) => {
            let _rows=result.rows_affected();
            if _rows==0{
                let code = AppError::from_err(format!("åº“é‡Œä¸å­˜åœ¨id:{}ï¼Œæ— æ³•åˆ é™¤",id).into(),crate::AppErrorType::Database);
                return Err(code);
            }
        },
        Err(err) => {
            println!("Err----{:?}",err);
            let code = AppError::from_err(err.into(),crate::AppErrorType::Database);
            return Err(code);
        }
    }

    Ok("ok".to_string())
}
```



è¯·æ±‚ä¸€ä¸‹ï¼š

```shell
$ curl -i -X POST -d "id"=50 127.0.0.1:3000/tag/del
HTTP/1.1 200 OK
content-type: application/json;charset=utf-8
content-length: 49
date: Fri, 24 Feb 2023 08:49:35 GMT

{"message":"åº“é‡Œä¸å­˜åœ¨id:50ï¼Œæ— æ³•åˆ é™¤"}

$ curl -i -X POST -d "id"=14 127.0.0.1:3000/tag/del
HTTP/1.1 200 OK
content-type: application/json;charset=utf-8
content-length: 49
date: Fri, 24 Feb 2023 08:49:35 GMT

{"message":"ok"}
```

æµè§ˆå™¨è®¿é—®ä¸€ä¸‹

![7.11.6](./7.11.6.jpg)
![7.11.6](./7.11.7.jpg)

å®Œç¾æ”¶å®˜ï¼