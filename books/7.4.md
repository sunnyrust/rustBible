# MVCæ¶æ„ä¸ä¼ è¾“å…¬å…±å‚æ•°
[TOC]

ä¸Šä¸€èŠ‚æˆ‘ä»¬å±•ç¤ºäº†`Axum`å¦‚ä½•ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œä¹Ÿæ˜¯å¾ˆè½»æ¾ã€‚

ä¸‹é¢æˆ‘ä»¬è¦ä½œä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯å¦‚ä½•ä½¿ç”¨å…¨å±€å‚æ•°ï¼Œè¿™ä¸€ç‚¹å¯¹å¼€å‘webæ˜¯å¾ˆé‡è¦çš„ã€‚

ç»å¸¸å¼€å‘webæœåŠ¡çš„äººéƒ½çŸ¥é“ï¼Œå…¨å±€å˜é‡æ˜¯å¿…é¡»çš„ï¼Œæ¯”å¦‚æ•°æ®åº“çš„è¿æ¥æ± ï¼Œè¿˜æœ‰ä¸€äº›å…¨å±€å˜é‡çš„å‚æ•°ã€‚å¦‚æœä½ æ˜¯åœ¨æ¯ä¸ªè¯·æ±‚æ¥çš„æ—¶å€™ä¸´æ—¶æ‰“å¼€æ•°æ®åº“è¿æ¥ï¼Œä½ æƒ³è±¡ä¸€ä¸‹é‚£ä¸ªè¯·æ±‚é€Ÿåº¦ä¼šä¸ä¼šå¾ˆæ…¢ï¼Ÿæ›´åˆ«è¯´é¢‘ç¹çš„æ‰“å¼€ã€å…³é—­æ•°æ®åº“å¯¹æ•°æ®åº“çš„è´Ÿè½½ä¹Ÿå¾ˆå¤§ã€‚è¿™ä¸ªæ˜¯webå°ç™½æ‰ä¼šçŠ¯çš„é”™è¯¯ã€‚

ä¸‹é¢å°±è·Ÿç€æˆ‘ï¼Œèµ°ä¸€ä¸‹æ­£ç¡®çš„é“è·¯å§ã€‚

## å…·ä½“æ“ä½œ


é¦–å…ˆä¿®æ”¹ä¸€ä¸‹`config.rs`æ–‡ä»¶

```rust
use serde::Deserialize;
#[derive(Deserialize)]
pub struct WebConfig {
    pub addr: String,
    pub version: String,
}
#[derive(Deserialize)]
pub struct Config {
    pub web: WebConfig,
}
impl Config {
    pub fn from_env() -> Result<Self, config::ConfigError> {
        config::Config::builder()
            .add_source(config::Environment::default())
            .build()?
            .try_deserialize()
    }
}
#[derive(Deserialize,Clone,Debug)]
pub struct WebInfo{
    pub web_addr:String,
    pub web_version:String,
}
```

## MVCæ¶æ„

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å…ˆç®€å•çš„æŠŠMVCçš„ç›®å½•æ¶æ„æ­å»ºèµ·æ¥ã€‚

```shell
$ mkdir src/controller
$ mkdir src/model
$ touch src/controller/mod.rs
$ touch src/model/mod.rs

$ tree
```

![ç»˜ç”»](./7.4.1.jpg)



åœ¨`controller`ç›®å½•é‡Œé¢æ·»åŠ ä¸€ä¸ª`index.rs`

```rust
pub async fn ping()-> String{
    String::from("Axum ping ğŸ¦¸.")
}
```

ä¿®æ”¹`controller/mod.rs`

```rust
pub mod index;
```

ä¿®æ”¹`lib.rs`

```rust
pub mod config;
pub mod controller;
pub mod model;
```





ä¿®æ”¹`src/main.rs`

```rust
use helloworld_axum::{config,controller};

//ä¿®æ”¹ä¸€ä¸‹è·¯ç”±
let app = Router::new()
            .route("/greet", get(|| async { "Hello, axum World!ğŸŒ±ğŸŒ" }))
            .route("/", get(root))
            .route("/do", get(get_fun).post(post_fun))
            .route("/index/ping", get(controller::index::ping));
```

è¿è¡Œçœ‹ä¸€ä¸‹æ•ˆæœ

![7.4.2](7.4.2.jpg)

æœ‰äº†è¿™ä¸ªç®€å•çš„æ¶æ„ï¼Œæˆ‘ä»¬ä½œè¿›ä¸€æ­¥çš„æ‹“å±•ï¼Œæˆ‘ä»¬æŠŠå‰é¢çš„é…ç½®ä¿¡æ¯ä¼ è¾“åˆ°controllerçš„indexé‡Œé¢ã€‚å…·ä½“æ“ä½œéœ€è¦å¾ˆå¤šæ­¥ï¼š

### ä¿®æ”¹`controller/mod.rs`

```rust
use crate::{config::WebInfo};
pub mod index;
#[allow(dead_code)]
fn get_web_info<'a>(state: &'a WebInfo) -> WebInfo{
   state.to_owned()
}
```

### ä¿®æ”¹`index.rs`

```rust
use axum::{extract::Path,Extension, };
use crate::{config::WebInfo};
use std::sync::Arc;
use super::{get_web_info,};
pub async fn getwebinfo(
    Extension(info): Extension<Arc<WebInfo>>,
)-> String{
    let info=get_web_info(&info);
    format!("web version {}",info.web_version)
}
pub async fn ping()-> String{
    String::from("Axum ping ğŸ¦¸.")
}
```

ä¿®æ”¹ä¸€ä¸‹`main.rs`

```rust
let cfg=config::Config::from_file("./app.toml").unwrap();
let web_info=config::WebInfo{
    web_addr:cfg.web.addr.clone(),
    web_version:cfg.web.version.clone(),
};
// å»ºç«‹ä¸€ä¸ªç®€å•çš„è·¯ç”±
let app = Router::new()
        .route("/greet", get(|| async { "Hello, axum World!ğŸŒ±ğŸŒ" }))
        .route("/", get(root))
        .route("/do", get(get_fun).post(post_fun))
        .route("/index/ping", get(controller::index::ping))
        .route("/index/info", get(controller::index::getwebinfo))
        .layer(Extension(Arc::new(web_info))) ;
```

è¯·æ±‚ä¸€ä¸‹

![7.4.x](./7.4.x.jpg)

æœ‰äº†è¿™ä¸ªåŠŸèƒ½ä»¥åï¼Œä¼ è¾“æ•°æ®åº“çš„å…¨å±€å˜é‡ï¼Œå°±å¾ˆæ–¹ä¾¿äº†ã€‚

å‰è¿›çš„è„šæ­¥ä¸èƒ½åœï¼Œæˆ‘ä»¬ä¸‹èŠ‚ç»§ç»­ã€‚
