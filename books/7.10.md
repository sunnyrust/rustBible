# ä½¿ç”¨ç¼“å­˜æŠ€æœ¯ä¿å­˜æ•°æ®åº“æŸ¥è¯¢ç»“æœ

[TOC]

ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬æ“ä½œäº†æ•°æ®åº“ï¼ŒæŠŠ`Tag`ä½¿ç”¨`BTreeâ€µå½¢å¼è¿”å›ï¼Œä¸è¿‡è¿™ä¸ªæ“ä½œæ˜æ˜¾æ˜¯ä¸€ä¸ªå¤æ‚çš„è®¡ç®—è¿‡ç¨‹ï¼Œå¦‚æœæ¯æ¬¡æœç´¢éƒ½é‡‡å–è¿™ç§æ–¹å¼ï¼Œæ˜¾ç„¶æ˜¯æ¯”è¾ƒè€—æ—¶ï¼Œä¹Ÿæ¯”è¾ƒè€—è´¹è®¡ç®—èµ„æºã€‚

è€Œè¿™ç§æ ‡ç­¾ï¼Œä¸€èˆ¬éƒ½ä¸ä¼šæœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå¦‚æœæŠŠæŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™ç›´æ¥æŠŠç»“æœè¿”å›æ˜¾ç„¶æ˜¯æœ€å¿«çš„ã€‚è¿™ä¸ªæ—¶å€™æœ‰åŒå­¦ä¼šé—®ï¼Œå¦‚æœ`Tag`é‡Œé¢çš„æ•°æ®è¢«ä½œäº†ä¿®æ”¹æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªå…¶å®éå¸¸ç®€å•ï¼Œç›´æ¥æŠŠç¼“å­˜åˆ é™¤å°±`OK`äº†ï¼Œè¿™æ ·ä¸‹æ¬¡æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå› ä¸ºæ²¡æœ‰ç¼“å­˜ï¼Œèµ°æ­£å¸¸çš„æœç´¢è·¯çº¿å°±å¥½ç„¶åæŠŠè®¡ç®—å¥½çš„æ•°æ®ç¼“å­˜ä¸‹æ¥ã€‚

å¸¸ç”¨çš„ç¼“å­˜ä¸­é—´ä»¶æœ‰`memcached`ã€`redis`ã€æ–‡ä»¶å‹ç­‰ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨`redis`æ¥ä¸¾ä¾‹ï¼Œå…·ä½“é‡‡ç”¨é‚£ç§ï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±é¡¹ç›®æƒ…å†µé€‰æ‹©æŠ€æœ¯æ ˆã€‚

## `0x00 docker`ä¸‹è½½å’Œå¯åŠ¨`redis`

```shell
$ sudo docker pull amd64/redis
$ mkdir dbs/redis && cd redis
$ wget http://download.redis.io/redis-stable/redis.conf
```

> *ä¿®æ”¹ bind 127.0.0.1/bind 127.0.0.1 -::1æ”¹ä¸º #bind 127.0.0.1 #ä½¿rediså¯ä»¥å¤–éƒ¨è®¿é—®
> *ä¿®æ”¹ #requirepass foobared æ”¹ä¸º requirepass ä½ çš„å¯†ç  #ç»™redisè®¾ç½®å¯†ç 
> ä¿®æ”¹ appendonly no æ”¹ä¸º appendonly yes #redisæŒä¹…åŒ–

```shell
$ docker run --name redis --restart=always -v /home/sunny/work/opt/dbs/redis/redis.conf:/etc/redis/redis.conf -v /home/sunny/work/opt/dbs/redis/data:/data -p 6379:6379 -it -d redis --appendonly yes --requirepass sunny

$ sudo apt-get install redis-tools # å®‰è£…å®¢æˆ·ç«¯
```

è¿™æ ·å°±å¯åŠ¨äº†`redis`ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å†™ç¨‹åºæ“ä½œã€‚

## `0x01  Rust`è¿æ¥redis



```shell
$ cargo add redis -F "tokio-comp,cluster,json"
```

```toml
[dependencies]
redis = { version = "0.22", features = ["tokio-comp", "cluster", "json"] }
```



åœ¨`.env`æœ€åæ·»åŠ ä¸€è¡Œ

```shell
REDIS.URL=redis://default:sunny@127.0.0.1/0
```

åœ¨`app.toml`æ·»åŠ 

```toml
[redis]
    url="redis://default:sunny@127.0.0.1/0"
```

### é¦–å…ˆã€ä¿®æ”¹ä¸€ä¸‹`config.rs`

```rust
#[derive(Deserialize)]
pub struct RedisConfig {   //å¢åŠ ä¸€ä¸ªRedisçš„struct
    pub url:String,   
}
#[derive(Deserialize)]
pub struct Config {
    pub web: WebConfig,
    pub db: DbConfig,
    pub redis:RedisConfig,  //æ­¤å¤„å¢åŠ redis
}
```

### å…¶æ¬¡ã€ä¿®æ”¹ä¸€ä¸‹`dbstate.rs`

```rust
use sqlx::PgPool;
use redis::Client;
pub struct DbState {
    pub conn: PgPool,
    pub redis_conn:Client,
}
```



### ä¸‰ã€ä¿®æ”¹ä¸€ä¸‹`model/mod.rs`ï¼Œå¢åŠ ä¸€ä¸ªå‡½æ•°

```rust
#[allow(dead_code)]
/// å–å¾—redisçš„conn
fn get_redis_conn<'a>(state: &'a DbState) -> &'a redis::Client {
    &state.redis_conn
}
```

### å››ã€ä¿®æ”¹ä¸€ä¸‹`main.rs`,è¿æ¥`redis`

```rust
// è¿æ¥redis
let redis_client=redis::Client::open(cfg.redis.url).expect("Redis Database connect error");
// å»ºç«‹ä¸€ä¸ªç®€å•çš„è·¯ç”±
let app =  router::init()
    .layer(TraceLayer::new_for_http())
    .layer(Extension(Arc::new(dbstate::DbState { conn: pool,redis_conn:redis_client})))
    .layer(Extension(Arc::new(web_info))) ;
```

### äº”ã€ä¿®æ”¹`model.tag.rs`,è®¾ç½®ç¼“å­˜ã€è¯»å–ç¼“å­˜

```rust
#[allow(dead_code)]
pub async fn get_tag_tree<'a>(state: &'a DbState) -> Result<Vec<TagModel>> {
    // æ“ä½œredis
    let client=get_redis_conn(&state);
    let mut redis_conn = client.get_connection().expect("redis connect error");
    let mut b_have_key=false;  //æ˜¯å¦æœ‰ç¼“å­˜
    let rv:redis::RedisResult<String> = redis_conn.get("tag_tree");//è¯»å–ç¼“å­˜
    let result =match rv {
        Ok(issue) => {
            b_have_key=true;
            issue
        },
        Err(_err) => {
            "".to_string()
        }
    };
    let mut  tag_models:Vec<TagModel>= vec![];
    if !b_have_key{
        let  sql=format!("SELECT id, name,pid from {} where id<>0;",get_table_name());
        let pool = get_conn(&state);
        let rows = sqlx::query_as::<_, Model>(&sql)
            .fetch_all(pool)
            .await
            .unwrap();
        let mut nodes: BTreeMap<i32, RefCell<TagNode>> = BTreeMap::new();
        for row in rows.clone() {
            let node=TagNode{id: row.id, name: row.name, parent_id: row.pid, childs: Vec::new(),level:0};
            nodes.insert(node.id, RefCell::new(node.clone()));
        }
        let mut tree: Vec<&RefCell<TagNode>> = Vec::new();
    
        for (node_id, node_ref) in nodes.iter() {
            // If node is a parent, store it directly on the tree
            if nodes[node_id].borrow().parent_id == 0 {
                tree.push(node_ref);
            }
            // If node is a child, insert it into its parent childs' vector
            else {
                let parent = &nodes[&node_ref.borrow().parent_id];
                let level=parent.borrow().level+1;
                node_ref.borrow_mut().level=level;
                parent.borrow_mut().add_child(&node_ref);
            }
        }
        
        for parent in tree.iter() {
            // parent.borrow().print_node(0);
            parent.borrow_mut().set_node_to_model(0, &mut tag_models);
        }

        // æ’å…¥redis
        let strm:String=serde_json::to_string(&tag_models).unwrap();
        let _:()=redis_conn.set("tag_tree",  strm).unwrap();
    }else{
        //æŠŠä»redisé‡Œé¢å–å‡ºæ¥çš„å­—ç¬¦ä¸²ï¼Œååºåˆ—åŒ–ä¸ºTagModelç»“æ„
        tag_models=serde_json::from_str(&result).unwrap();
    }
    
    Ok(tag_models)
}
```

ç»è¿‡ä¸Šé¢çš„æ“ä½œ,æ•°æ®å·²ç»è¿”å›çš„æ˜¯æˆ‘å¸Œæœ›çš„ç»“æœäº†ï¼Œè¯·æ±‚ä¸€ä¸‹ï¼š

```shell
$ curl -i http://127.0.0.1:3000/tag/tree
HTTP/1.1 200 OK
content-type: application/json;charset=utf-8
content-length: 628
date: Wed, 22 Feb 2023 08:05:04 GMT

{"result":[{"id":1,"level":0,"name":"æ–‡å­—","pid":0},{"id":2,"level":1,"name":"QA","pid":1},{"id":3,"level":1,"name":"FAQ","pid":1},{"id":4,"level":0,"name":"éŸ³é¢‘","pid":0},{"id":5,"level":1,"name":"æ­Œæ›²","pid":4},{"id":6,"level":1,"name":"æˆæ›²","pid":4},{"id":7,"level":1,"name":"éŸ³ä¹","pid":4},{"id":8,"level":2,"name":"æ°‘ä¹","pid":7},{"id":9,"level":2,"name":"è½»éŸ³ä¹","pid":7},{"id":10,"level":2,"name":"äº¤å“ä¹","pid":7},{"id":11,"level":2,"name":"ç”µå­éŸ³ä¹","pid":7},{"id":12,"level":0,"name":"åŠ¨ä½œ","pid":0},{"id":13,"level":1,"name":"æ‰‹ğŸ‘‹","pid":12},{"id":14,"level":1,"name":"è„šğŸ©¹","pid":12}]}
```

é€Ÿåº¦ä¹Ÿæ˜¯é£å¿«ï¼èƒ½ä¸å¿«å—ï¼Ÿç›´æ¥ä»ç¼“å­˜è¯»å–çš„ã€‚