# é…ç½®æ–‡ä»¶
[TOC]

ä¸Šä¸€èŠ‚æˆ‘ä»¬å±•ç¤ºäº†`Axum`å¦‚ä½•logè¾“å‡ºï¼Œä¹Ÿæ˜¯å¾ˆè½»æ¾ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥æ“ä½œä¸€ä¸‹é…ç½®æ–‡ä»¶ã€‚

ç»å¸¸å¼€å‘webæœåŠ¡çš„äººéƒ½çŸ¥é“ï¼ŒåŸºæœ¬è®¾ç½®ã€æ•°æ®åº“è®¾ç½®ã€ä¸­é—´ä»¶è®¾ç½®éƒ½ä¼šæ”¾åœ¨é…ç½®æ–‡ä»¶é‡Œé¢ã€‚

å¦‚æœï¼Œå…¨éƒ¨`hardcode`åœ¨ç¨‹åºé‡Œé¢ï¼Œçµæ´»æ€§å®Œå…¨æ²¡æ³•ä¿è¯ã€‚

æˆç†Ÿçš„æ¡†æ¶éƒ½ä¼šæœ‰é…ç½®æ–‡ä»¶ï¼Œ`Axum`ä¹Ÿä¸ä¾‹å¤–ã€‚

`Axum`ä¸ä¼—ä¸åŒçš„åœ°æ–¹æ˜¯å¸¸ç”¨çš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯`.env`ã€‚è¿™ä¸ªå¯¹äºä¹ æƒ¯äº†ä½¿ç”¨Windowsçš„äººæ¥è¯´ä¸æ˜¯é‚£ä¹ˆå‹å¥½ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘å†ä»‹ç»ä¸€ç§ä½¿ç”¨TOMLçš„æ–¹å¼ã€‚

## config!
åœ¨`helloworld-axum`é¡¹ç›®ä¸Šç»§ç»­æ·»åŠ `crate`ã€‚
```shell
$ cargo add config 
$ cargo add  serde -F "derive"
$ cargo add dotenv
```
```toml
[dependencies]
config = "0.13.3"
dotenv = "0.15.0"
serde = { version = "1.0.152", features = ["derive"] }
#ä¿®æ”¹ä¸€ä¸‹
[dependencies]
config = "0.13"
dotenv = "0.15"
serde = { version = "1.0", features = ["derive"] }
```

æˆ‘ä»¬å…ˆè®²è§£ä¸€ä¸‹`.env`çš„æ–¹å¼ã€‚é¦–å…ˆåœ¨æ ¹ç›®å½•é‡Œé¢å»ºä¸€ä¸ª`.env`æ–‡ä»¶

```shell
$ touch helloworld-axum/.env
$ echo "WEB.ADDR=0.0.0.0:3000" >> .env
$ echo "WEB.VERSION=0.1.0" >> .env
$ cat .env
```

![7.3.1](./7.3.1.jpg)

åœ¨`src`ç›®å½•ä¸‹å¢åŠ ä¸¤ä¸ªæ–‡ä»¶`lib.rs`å’Œ`config.rs`

`lib.rs`

```rust
pub mod config;
```

`config.rs`

```rust
use serde::Deserialize;
#[derive(Deserialize)]
pub struct WebConfig {
    pub addr: String,
    pub version: String,
}

#[derive(Deserialize)]
pub struct Config {
    pub web: WebConfig,
}
impl Config {
    pub fn from_env() -> Result<Self, config::ConfigError> {
        config::Config::builder()
            .add_source(config::Environment::default())
            .build()?
            .try_deserialize()
    }
}
```



ä¿®æ”¹`src/main.rs`

```rust
use axum::{
    routing::get,
    Router,
};
use dotenv::dotenv;
use helloworld_axum::config;
#[tokio::main]
async fn main() {
    eprintln!(
r#"
â•”â•â•â•—
â•šâ•—â•”â•
â•”â•(Â¯`vÂ´Â¯)
â•šâ•â•`.Â¸.[ğŸ…° ğŸ†‡ ğŸ†„ ğŸ…¼ ğŸŒğŸŒ±]
"#);
    if std::env::var_os("RUST_LOG").is_none() {
        std::env::set_var("RUST_LOG", "helloworld_axum=debug");
    }
    dotenv().ok();
    tracing_subscriber::fmt::init();
    // å»ºç«‹ä¸€ä¸ªç®€å•çš„è·¯ç”±
    let app = Router::new()
            .route("/greet", get(|| async { "Hello, axum World!ğŸŒ±ğŸŒ" }))
            .route("/", get(root))
            .route("/do", get(get_fun).post(post_fun))
            ;
    let cfg = config::Config::from_env().unwrap();
    tracing::info!("ğŸŒ±ğŸŒ æœåŠ¡ç›‘å¬äº{}ğŸŒğŸŒ±", &cfg.web.addr);
    // èµ·ä¸€ä¸ªhttpæœåŠ¡ï¼Œç«¯å£ä¾é è¯»å–.envæ–‡ä»¶è·å¾—
    axum::Server::bind(&cfg.web.addr.parse().unwrap())
        .serve(app.into_make_service())
        .await
        .unwrap();
}
async fn root() -> String {
    tracing::info!("Hello rootğŸ˜€");
    String::from("Hello rootğŸ˜€.")
}
async fn get_fun() -> String {
    tracing::debug!("get functionğŸ‘‹");
    String::from("get functionğŸ‘‹\n")
}
async fn post_fun() -> String {
    tracing::warn!("post functionğŸ ");
    String::from("post functionğŸ \n")
}
```

è¿è¡Œçœ‹ä¸€ä¸‹æ•ˆæœ

![7.2.1](7.2.1.jpg)

æ˜¯ä¸æ˜¯æ˜¾å¾—ä¸“ä¸šäº†å¾ˆå¤šï¼Ÿ

ä¸è¿‡è¿™ä¸ªæ–¹å¼æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨`linux`ç³»ç»Ÿä¸‹é¢ä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†æ˜¯åœ¨windowsä¸‹å°±ä¼šå¾ˆéº»çƒ¦ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`toml`æ–‡ä»¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜,æ–°å»ºä¸€ä¸ª`app.toml`æ–‡ä»¶ã€‚

```rust
[web]
    addr="0.0.0.0:3000"
    version="0.1.0"
```

ä¿®æ”¹ä¸€ä¸‹ä»£ç ã€‚é¦–å…ˆåœ¨`config.rs`é‡Œé¢æ·»åŠ ä¸€ä¸‹

```rust
use serde::Deserialize;
#[derive(Deserialize)]
pub struct WebConfig {
    pub addr: String,
    pub version: String,
}

#[derive(Deserialize)]
pub struct Config {
    pub web: WebConfig,
}
impl Config {
    /// ä»ç¯å¢ƒè¯»å–
    pub fn from_env() -> Result<Self, config::ConfigError> {
        config::Config::builder()
            .add_source(config::Environment::default())
            .build()?
            .try_deserialize()
    }
    /// ä»æ–‡ä»¶è¯»å–
    pub fn from_file(path: &'static str) -> Result<Self, config::ConfigError> {
        config::Config::builder()
        .add_source(config::File::with_name(path))
        .add_source(config::Environment::default())
        .build()?
        .try_deserialize()
    }
}
```

ä¿®æ”¹ä¸€ä¸‹`main.rs`

åªéœ€è¦æ›´æ¢ä¸€è¡Œä»£ç ï¼Œå¤§çº¦åœ¨27è¡Œã€‚

```rust
// let cfg = config::Config::from_env().unwrap();
let cfg=config::Config::from_file("./app.toml").unwrap();
```

![7.3.2](./7.3.2.jpg)

çœ‹èµ·æ¥å¾ˆç®€å•å§ï¼Œé‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±å¼€å§‹æ–°çš„æŒ‘æˆ˜å§ï¼
